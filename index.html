<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>چلنج 2048</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css?family=Clear+Sans:400,300,600,700" rel="stylesheet">
  <link rel="stylesheet" href="https://gabrielecirulli.github.io/2048/style/main.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
</head>
<body>
  <h1>ساخت چلنج جدید</h1>
  <form id="challengeForm">
    <input type="text" name="title" placeholder="عنوان چلنج" required><br>
    <label>زمان شروع:</label>
    <input type="datetime-local" name="startTime" required><br>
    <label>زمان پایان:</label>
    <input type="datetime-local" name="endTime" required><br>
    <button type="submit">ساخت چلنج</button>
  </form>
  <div id="linkBox"></div>

  <hr>
  <h2>ورود به چلنج</h2>
  <input type="text" id="challengeIdInput" placeholder="شناسه چلنج">
  <button onclick="loadChallenge()">ورود</button>

  <div id="gameArea" style="display:none;">
    <h2 id="challengeTitle"></h2>
    <p id="timeStatus"></p>

    <!-- بازی 2048 -->
    <div class="container">
      <div class="heading">
        <h1 class="title">2048</h1>
        <div class="scores-container">
          <div class="score-container" id="score">0</div>
        </div>
      </div>
      <div class="game-container">
        <div class="grid-container">
          <!-- grid cells will be generated by JS -->
        </div>
        <div class="tile-container"></div>
      </div>
      <button onclick="endGame()">پایان بازی</button>
    </div>

    <div id="leaderboard">
      <h3>لیدربرد</h3>
      <ul id="scoreList"></ul>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDhmbx2vQkRBk1r9j21bwuzFw3uEJUdZDY",
      authDomain: "project-4706304311592930157.firebaseapp.com",
      projectId: "project-4706304311592930157",
      storageBucket: "project-4706304311592930157.firebasestorage.app",
      messagingSenderId: "401832134319",
      appId: "1:401832134319:web:99704cf6ec3d2b89cd765a",
      measurementId: "G-LVXWPLG38Q"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.getElementById('challengeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      const docRef = await db.collection("challenges").add({
        title: data.title,
        startTime: data.startTime,
        endTime: data.endTime
      });
      document.getElementById('linkBox').innerHTML = `لینک چلنج: <b>${docRef.id}</b>`;
    });

    let currentChallengeId = null;
    let currentChallenge = null;

    async function loadChallenge() {
      const id = document.getElementById("challengeIdInput").value.trim();
      if (!id) return alert("شناسه چلنج را وارد کنید");
      const doc = await db.collection("challenges").doc(id).get();
      if (!doc.exists) return alert("چلنج پیدا نشد");
      currentChallengeId = id;
      currentChallenge = doc.data();

      const now = new Date();
      const start = new Date(currentChallenge.startTime);
      const end = new Date(currentChallenge.endTime);

      if (now < start) return alert("چلنج هنوز شروع نشده!");
      if (now > end) return alert("چلنج به پایان رسیده.");

      document.getElementById("challengeTitle").innerText = currentChallenge.title;
      document.getElementById("timeStatus").innerText = `فعال تا: ${end.toLocaleString("fa-IR")}`;
      document.getElementById("gameArea").style.display = "block";
      loadLeaderboard();
      startGame(); // اجرای بازی
    }

    async function endGame() {
      const name = prompt("نام خود را وارد کنید:");
      const score = parseInt(document.getElementById("score").innerText, 10);
      if (!name || isNaN(score)) return alert("اطلاعات نامعتبر");

      await db.collection("challenges").doc(currentChallengeId)
        .collection("leaderboard").add({
          name,
          score,
          timestamp: new Date().toISOString()
        });
      alert("امتیاز ثبت شد!");
      loadLeaderboard();
    }

    async function loadLeaderboard() {
      const list = document.getElementById("scoreList");
      list.innerHTML = "";
      const start = new Date(currentChallenge.startTime).toISOString();
      const end = new Date(currentChallenge.endTime).toISOString();

      const q = db.collection("challenges").doc(currentChallengeId)
        .collection("leaderboard")
        .where("timestamp", ">=", start)
        .where("timestamp", "<=", end)
        .orderBy("score", "desc");

      const snapshot = await q.get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.innerText = `${data.name}: ${data.score}`;
        list.appendChild(li);
      });
    }

    // اجرای بازی 2048
    function startGame() {
      // فرض می‌گیریم فایل‌های اصلی بازی 2048 مثل game_manager.js و keyboard_input_manager.js در پروژه‌ات هستن
      // فقط مطمئن شو که امتیاز در #score نمایش داده می‌شه
    }
  </script>
</body>
</html>
