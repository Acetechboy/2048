<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <title>2048 چَلِنج</title>
  <link href="style/main.css" rel="stylesheet" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body dir="rtl">
  <div class="container">
    <div class="heading">
      <h1 class="title">2048 چَلِنج</h1>
      <div class="scores-container">
        <div class="score-container">0</div>
        <div class="best-container">0</div>
      </div>
    </div>

    <div id="auth-section" style="text-align:center; margin: 20px;">
      <button id="googleLogin">ورود با گوگل</button>
      <button id="guestLogin">ورود به عنوان مهمان</button>
      <div id="nameInput" style="display:none; margin-top:10px;">
        <input id="guestName" placeholder="نام خود را وارد کنید">
        <button id="saveGuestName">ادامه</button>
      </div>
    </div>

    <div id="challenge-section" style="display:none; text-align:center;">
      <button id="createChallenge">ساخت چالش جدید</button>
      <div id="challengeForm" style="display:none; margin-top:10px;">
        <input id="challengeName" placeholder="نام چالش">
        <input id="challengeTime" type="number" placeholder="مدت (دقیقه)">
        <button id="startChallenge">شروع</button>
      </div>
      <div id="leaderboard" style="margin-top:20px;"></div>
    </div>

    <div id="game-section" style="display:none;">
      <div class="game-container">
        <div class="grid-container">
          <div class="grid-row">
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
          </div><div class="grid-row">
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
          </div><div class="grid-row">
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
          </div><div class="grid-row">
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
          </div>
        </div>
        <div class="tile-container"></div>
      </div>
      <p id="timer" style="text-align:center; margin-top:10px;">زمان باقی‌مانده: 30:00</p>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDhmbx2vQkRBk1r9j21bwuzFw3uEJUdZDY",
      authDomain: "project-4706304311592930157.firebaseapp.com",
      projectId: "project-4706304311592930157",
      storageBucket: "project-4706304311592930157.firebasestorage.app",
      messagingSenderId: "401832134319",
      appId: "1:401832134319:web:99704cf6ec3d2b89cd765a",
      measurementId: "G-LVXWPLG38Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let challengeActive = false;
    let timerInterval;

    // ورود با گوگل
    document.getElementById("googleLogin").onclick = async () => {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        currentUser = result.user;
        showChallengeMenu();
      } catch (err) {
        alert("خطا در ورود با گوگل");
      }
    };

    // ورود مهمان
    document.getElementById("guestLogin").onclick = () => {
      document.getElementById("nameInput").style.display = "block";
    };

    document.getElementById("saveGuestName").onclick = async () => {
      const name = document.getElementById("guestName").value.trim();
      if (!name) return alert("نام را وارد کنید");
      await signInAnonymously(auth);
      currentUser = { displayName: name, uid: Math.random().toString(36).slice(2) };
      showChallengeMenu();
    };

    function showChallengeMenu() {
      document.getElementById("auth-section").style.display = "none";
      document.getElementById("challenge-section").style.display = "block";
    }

    // ساخت چالش جدید
    document.getElementById("createChallenge").onclick = () => {
      document.getElementById("challengeForm").style.display = "block";
    };

    document.getElementById("startChallenge").onclick = () => {
      const name = document.getElementById("challengeName").value.trim();
      const time = parseInt(document.getElementById("challengeTime").value) || 30;
      if (!name) return alert("نام چالش را وارد کنید");
      startChallenge(name, time);
    };

    async function startChallenge(name, time) {
      challengeActive = true;
      document.getElementById("challenge-section").style.display = "none";
      document.getElementById("game-section").style.display = "block";
      loadGame();
      startTimer(time);
    }

    function loadGame() {
      // فایل‌های اصلی بازی 2048
      const scripts = [
        "js/bind_polyfill.js",
        "js/classlist_polyfill.js",
        "js/animframe_polyfill.js",
        "js/keyboard_input_manager.js",
        "js/html_actuator.js",
        "js/grid.js",
        "js/tile.js",
        "js/local_storage_manager.js",
        "js/game_manager.js",
        "js/application.js"
      ];
      scripts.forEach(src => {
        const s = document.createElement("script");
        s.src = src;
        document.body.appendChild(s);
      });
    }

    function startTimer(minutes) {
      let remaining = minutes * 60;
      timerInterval = setInterval(() => {
        const min = Math.floor(remaining / 60);
        const sec = remaining % 60;
        document.getElementById("timer").textContent = `زمان باقی‌مانده: ${min}:${sec < 10 ? '0' : ''}${sec}`;
        remaining--;
        if (remaining < 0) {
          clearInterval(timerInterval);
          challengeActive = false;
          alert("زمان تمام شد!");
        }
      }, 1000);
    }

    async function saveScore(score) {
      if (!currentUser) return;
      await setDoc(doc(db, "leaderboard", currentUser.uid), {
        name: currentUser.displayName || "مهمان",
        score: score,
        timestamp: new Date()
      });
    }

  </script>
</body>
</html>
