<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ú†Ù„Ù†Ø¬ 2048</title>
  <link href="style/main.css" rel="stylesheet" />
  <style>
    body {
      direction: rtl;
      background: #faf8ef;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #leaderboard {
      margin-top: 20px;
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      max-width: 400px;
      margin-inline: auto;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 6px;
    }
    th {
      background: #8f7a66;
      color: white;
    }
    #status {
      margin: 10px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>ğŸ† Ú†Ù„Ù†Ø¬ 2048</h2>
  <div id="status">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>

  <!-- Ø¨Ø§Ø²ÛŒ -->
  <iframe id="gameFrame" src="game.html" width="350" height="420" frameborder="0" style="display:none;"></iframe>

  <!-- Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯ -->
  <div id="leaderboard" style="display:none;">
    <h3>ğŸ… Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯</h3>
    <table>
      <thead>
        <tr><th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th><th>Ø§Ù…ØªÛŒØ§Ø²</th></tr>
      </thead>
      <tbody id="board"></tbody>
    </table>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDhmbx2vQkRBk1r9j21bwuzFw3uEJUdZDY",
      authDomain: "project-4706304311592930157.firebaseapp.com",
      projectId: "project-4706304311592930157",
      storageBucket: "project-4706304311592930157.firebasestorage.app",
      messagingSenderId: "401832134319",
      appId: "1:401832134319:web:99704cf6ec3d2b89cd765a",
      measurementId: "G-LVXWPLG38Q"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Ú¯Ø±ÙØªÙ† ID Ú†Ù„Ù†Ø¬ Ø§Ø² Ù„ÛŒÙ†Ú©
    const params = new URLSearchParams(window.location.search);
    const challengeId = params.get('id');
    const statusEl = document.getElementById('status');
    const gameFrame = document.getElementById('gameFrame');
    const leaderboard = document.getElementById('leaderboard');
    const board = document.getElementById('board');

    async function init() {
      if (!challengeId) {
        statusEl.textContent = "âŒ Ø´Ù†Ø§Ø³Ù‡ Ú†Ù„Ù†Ø¬ ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        return;
      }

      const doc = await db.collection("challenges").doc(challengeId).get();
      if (!doc.exists) {
        statusEl.textContent = "âŒ Ú†Ù„Ù†Ø¬ ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        return;
      }

      const data = doc.data();
      const start = new Date(data.startTime);
      const end = new Date(data.endTime);
      const now = new Date();

      if (now < start) {
        const diff = Math.round((start - now) / 60000);
        statusEl.textContent = `â³ Ú†Ù„Ù†Ø¬ Ù‡Ù†ÙˆØ² Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡ (Ø´Ø±ÙˆØ¹ Ø¯Ø± ${start.toLocaleString()})`;
      } else if (now > end) {
        statusEl.textContent = "âŒ› Ø²Ù…Ø§Ù† Ú†Ù„Ù†Ø¬ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡.";
        showLeaderboard();
      } else {
        statusEl.textContent = "ğŸ”¥ Ú†Ù„Ù†Ø¬ ÙØ¹Ø§Ù„ Ø§Ø³Øª! Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.";
        gameFrame.style.display = "block";
        leaderboard.style.display = "block";
        showLeaderboard();
      }
    }

    async function showLeaderboard() {
      const snapshot = await db.collection("challenges")
        .doc(challengeId)
        .collection("leaderboard")
        .orderBy("score", "desc")
        .get();

      board.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const row = `<tr><td>${d.name}</td><td>${d.score}</td></tr>`;
        board.innerHTML += row;
      });
    }

    // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù„Ø§Ø¯Ø±Ù†Ú¯ Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
    db.collection("challenges").doc(challengeId)
      .collection("leaderboard")
      .orderBy("score", "desc")
      .onSnapshot(snapshot => {
        board.innerHTML = "";
        snapshot.forEach(doc => {
          const d = doc.data();
          const row = `<tr><td>${d.name}</td><td>${d.score}</td></tr>`;
          board.innerHTML += row;
        });
      });

    init();
  </script>
</body>
</html>
